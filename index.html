<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <style>
        @font-face {
            font-family: 'CasinoFlat';
            src: url('https://ascenxi0n.github.io/crpl.github.io/Casino.ttf') format('truetype');
        }

        body { 
            font-family: 'CasinoFlat', Arial, sans-serif; 
            text-align: center;
            background: transparent;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* Leaderboard Container */
        #leaderboard-container {
            width: vw;
            height: vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Table */
        table { 
            width: 60%; 
            height: 100%;
            border-collapse: collapse; 
            background: transparent;
            table-layout: fixed;
        }

        /* Table Cells */
        td { 
            padding: 1vh; 
            font-size: 24px; 
            color: #FF3300; 
            -webkit-text-stroke: 0.7px orange;
            border: none; 
            text-align: center;
            background: transparent;
            letter-spacing: 2px;
            line-height: 90%;
            width: 33.3%; 
            overflow: hidden;
            white-space: nowrap;
        }

        /* Shrinking Text If Overflowing */
        .shrink-text {
            display: inline-block;
            max-width: 100%;
            font-size: 24px;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Swivel Animation for Full Refresh */
        @keyframes swivel {
            0% { transform: rotateY(0deg); opacity: 1; }
            50% { transform: rotateY(90deg); opacity: 0; }
            100% { transform: rotateY(0deg); opacity: 1; }
        }

        /* Slot Machine Spin for Individual Updates */
        @keyframes spin {
            0% { transform: rotateX(0deg); opacity: 1; }
            50% { transform: rotateX(90deg); opacity: 0.2; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }

        .swivel { animation: swivel 0.7s ease-in-out; }
        .spin { animation: spin 0.5s ease-in-out; }

        /* Column Alignments */
        .rank { text-align: left; }
        .name { text-align: center; }
        .points { text-align: right; }

    </style>
</head>
<body>
    <div id="leaderboard-container">
        <table id="leaderboard">
            <tbody></tbody>
        </table>
    </div>
    
    <audio id="updateSound" src="https://ascenxi0n.github.io/crpl.github.io/update.wav"></audio>
    
    <script>
        let previousData = [];
        const API_URL = "https://script.google.com/macros/s/AKfycbz6rXpt5A4RQUZJ20EZwlaM8twF79urX21FqvL_aSeE7_2rxFac-KEn8iWCR7WeKhNr/exec?data=true";
        const updateSound = document.getElementById("updateSound");

        async function fetchLeaderboardData() {
            try {
                console.log("Fetching leaderboard data...");
                const response = await fetch(API_URL);
                let result = await response.json();
                
                // Remove empty entries
                result = result.filter(entry => entry.player && entry.points !== "");

                if (!isDataSame(result, previousData)) {
                    startRotatingLeaderboard(result);
                    playUpdateSound();
                }

                setTimeout(fetchLeaderboardData, 10000);
            } catch (error) {
                console.error("Error fetching data:", error);
                setTimeout(fetchLeaderboardData, 10000);
            }
        }

        function isDataSame(newData, oldData) {
            return JSON.stringify(newData) === JSON.stringify(oldData);
        }

        function playUpdateSound() {
            updateSound.currentTime = 0;
            updateSound.play();
        }

        let currentIndex = 0;

        function startRotatingLeaderboard(data) {
            if (data.length === 0) return;

            function updateTable() {
                let tableBody = document.querySelector("#leaderboard tbody");
                tableBody.innerHTML = "";

                // Get the next 5 entries
                let displayedEntries = data.slice(currentIndex, currentIndex + 5);
                if (displayedEntries.length < 5) {
                    currentIndex = 0; // Reset if less than 5 remain
                    displayedEntries = data.slice(currentIndex, currentIndex + 5);
                }

                displayedEntries.forEach((entry, index) => {
                    let row = document.createElement("tr");

                    let rankCell = document.createElement("td");
                    rankCell.classList.add("rank");
                    rankCell.innerHTML = `<span class="shrink-text swivel">${currentIndex + index + 1}</span>`;

                    let playerCell = document.createElement("td");
                    playerCell.classList.add("name");
                    let playerChanged = previousData[currentIndex + index] && previousData[currentIndex + index].player !== entry.player;
                    playerCell.innerHTML = `<span class="shrink-text ${playerChanged ? 'spin' : 'swivel'}">${entry.player}</span>`;

                    let pointsCell = document.createElement("td");
                    pointsCell.classList.add("points");
                    let pointsChanged = previousData[currentIndex + index] && previousData[currentIndex + index].points !== entry.points;
                    pointsCell.innerHTML = `<span class="shrink-text ${pointsChanged ? 'spin' : 'swivel'}">${entry.points}</span>`;

                    row.appendChild(rankCell);
                    row.appendChild(playerCell);
                    row.appendChild(pointsCell);
                    tableBody.appendChild(row);
                });

                currentIndex += 5;
                if (currentIndex >= data.length) currentIndex = 0;

                applyAnimations();
            }

            updateTable();
            setInterval(updateTable, 10000);
        }

        function applyAnimations() {
            document.querySelectorAll(".swivel, .spin").forEach(el => {
                el.classList.remove("swivel", "spin");
                void el.offsetWidth; // Force reflow
                el.classList.add(el.classList.contains("spin") ? "spin" : "swivel");
            });
        }

        fetchLeaderboardData();
    </script>
</body>
</html>
