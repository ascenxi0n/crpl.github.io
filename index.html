<script>
    let previousData = [];
    let currentIndex = 0;
    const API_URL = "https://script.google.com/macros/s/AKfycbz6rXpt5A4RQUZJ20EZwlaM8twF79urX21FqvL_aSeE7_2rxFac-KEn8iWCR7WeKhNr/exec?data=true";
    const updateSound = document.getElementById("updateSound");

    async function fetchLeaderboardData() {
        try {
            console.log("Fetching leaderboard data...");
            const response = await fetch(API_URL, { cache: "no-cache" });

            if (!response.ok) {
                throw new Error(`HTTP Error! Status: ${response.status}`);
            }

            const result = await response.json();
            console.log("Leaderboard Data Fetched:", result);

            // Filter out empty entries
            const filteredData = result.filter(entry => entry.player && entry.points);

            if (!filteredData.length) {
                console.warn("Warning: Leaderboard data is empty.");
            }

            if (!isDataSame(filteredData, previousData)) {
                previousData = [...filteredData];
                currentIndex = 0; // Reset index on new data
                updateTable();
                playUpdateSound();
            }

            setTimeout(fetchLeaderboardData, 10000); // Fetch every 10s
        } catch (error) {
            console.error("Error fetching leaderboard data:", error.message);
            setTimeout(fetchLeaderboardData, 10000);
        }
    }

    function isDataSame(newData, oldData) {
        return JSON.stringify(newData) === JSON.stringify(oldData);
    }

    function playUpdateSound() {
        updateSound.currentTime = 0;
        updateSound.play();
    }

    function updateTable() {
        let tableBody = document.querySelector("#leaderboard tbody");
        tableBody.innerHTML = "";

        if (!previousData.length) {
            console.warn("No valid leaderboard data to display.");
            return;
        }

        let maxEntries = 5;
        let slicedData = previousData.slice(currentIndex, currentIndex + maxEntries);

        if (slicedData.length === 0) {
            currentIndex = 0;
            slicedData = previousData.slice(0, maxEntries);
        }

        slicedData.forEach((entry, i) => {
            let row = document.createElement("tr");
            let rankCell = document.createElement("td");
            let playerCell = document.createElement("td");
            let pointsCell = document.createElement("td");

            let actualRank = currentIndex + i + 1; // Calculate global rank

            rankCell.className = "rank";
            playerCell.className = "name";
            pointsCell.className = "points";

            rankCell.innerHTML = `<span class="spin">${actualRank}</span>`;
            playerCell.innerHTML = `<span class="spin">${entry.player}</span>`;
            pointsCell.innerHTML = `<span class="spin">${entry.points}</span>`;

            row.appendChild(rankCell);
            row.appendChild(playerCell);
            row.appendChild(pointsCell);
            tableBody.appendChild(row);
        });

        currentIndex += maxEntries;
        if (currentIndex >= previousData.length) {
            currentIndex = 0;
        }

        setTimeout(updateTable, 10000);
    }

    fetchLeaderboardData();
</script>
